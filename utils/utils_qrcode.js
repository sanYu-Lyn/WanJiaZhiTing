import http from '../http/http_do'

const doTask = function () {
  if (!getApp().globalData.task) {
    return
  }
  // if (!checkLoginState()) {
  //   return
  // }
  if (getApp().globalData.task.to === 'out') {
    scanOut()
    return
  }

  if (getApp().globalData.task.to === 'parkout') {
    jumpToSelectCar()
    return
  }

  // if (getApp().globalData.task) {  
  //   if (checkLoginState()) {
  //     switch (getApp().globalData.task.to) {
  //       case '1':
  //         checkNeedPayOrder()
  //         break;
  //       case '2':
  //         buyRentCard()
  //         break;
  //     }
  //   }
  // } else {
  //   let pages = getCurrentPages();
  //   if (pages.length > 1) {
  //     wx.navigateBack()
  //   }
  // }
  wx.navigateBack()
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////出场扫码查询待支付订单//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/**
 *检测用是否登录，未登录跳转到登录界面
 */
const checkLoginState = function () {
  if (!getApp().globalData.userInfo) {
    wx.redirectTo({
      url: '../base_login/base_login',
    })
    return false //未登录
  }
  return true //已登录
}

const scanOut = function () {
  http.scanOut('212', '桂A888888',
    () => wx.showLoading(),
    res => {
      wx.hideLoading()
      jumpToOrderPay(res.data)
    },
    res => wx.hideLoading()
  )
}

const parkOut = function () {
  http.parkOut('1', '桂A888888',
    () => wx.showLoading(),
    res => {
      wx.hideLoading()
      jumpToSelectCar()
    },
    res => wx.hideLoading()
  )
}

/**
 * 检测是否有待支付的订单
 */
const checkNeedPayOrder = function () {
  http.needToPayOrder(
    () => wx.showLoading(),
    res => {
      if (res.data && res.data.content[0]) {
        jumpToOrderPay(res.data.content[0])
      } else {
        jumpToSelectCar()
      }
      wx.hideLoading()
    },
    res => wx.hideLoading()
  )

  getApp().globalData.task = null
}

/**
 * 跳转到订单支付界面
 */
const jumpToOrderPay = function (order) {
  order.status = 'needToPay'
  const params = encodeURIComponent(JSON.stringify(order))
  wx.redirectTo({
    url: '../fee_pay/fee_pay?order=' + params,
  })
}

/**
 * 跳转到选择车辆界面
 */
const jumpToSelectCar = function () {
  wx.redirectTo({
    url: '../fee_cars/fee_cars?to=out',
  })

}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////出场扫码查询待支付订单//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////月卡续租////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/**
 * 续费月卡
 */
const buyRentCard = function () {
  if (getApp().globalData.task.id) {
    var carId = getApp().globalData.task.id
  } else {
    wx.navigateTo({
      url: '../rent_card/rent_card',
    })
  }
  getApp().globalData.task = null
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////月卡续租////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

module.exports = {
  doTask: doTask,
}